local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

local espEnabled = false
local espTags = {}

-- เปิด-ปิด ESP
function toggleESP()
    espEnabled = not espEnabled

    if not espEnabled then
        for _, tag in pairs(espTags) do
            tag:Destroy()
        end
        espTags = {}
    end
end

-- สร้าง BillboardGui แสดงชื่อผู้เล่นเหนือหัว (ทะลุผนัง)
function createNameTag(player)
    if not player.Character or not player.Character:FindFirstChild("Head") then return nil end

    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "ESPNameTag"
    billboardGui.Adornee = player.Character.Head
    billboardGui.AlwaysOnTop = true -- มองทะลุวัตถุ
    billboardGui.Size = UDim2.new(0, 120, 0, 40)
    billboardGui.StudsOffset = Vector3.new(0, 2, 0)
    billboardGui.Parent = player.Character.Head

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1, 0, 0) -- สีแดง
    textLabel.TextStrokeTransparency = 0.5
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextScaled = true
    textLabel.Text = player.Name
    textLabel.Parent = billboardGui

    return billboardGui
end

-- เช็คโหมด Deathmatch
local function isDeathmatchMode()
    local localPlayer = Players.LocalPlayer
    if not localPlayer.Team then return true end
    if localPlayer.Team.Name == "None" then return true end
    return false
end

-- อัพเดต BillboardGui ทุกเฟรม
RunService.RenderStepped:Connect(function()
    if not espEnabled then return end

    local deathmatch = isDeathmatchMode()
    local localPlayer = Players.LocalPlayer

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer
           and player.Character
           and player.Character:FindFirstChild("Head") then

            local showESP = false
            if deathmatch then
                showESP = true
            else
                if localPlayer.Team and player.Team and player.Team ~= localPlayer.Team then
                    showESP = true
                end
            end

            if showESP then
                if not espTags[player] then
                    espTags[player] = createNameTag(player)
                end
            else
                if espTags[player] then
                    espTags[player]:Destroy()
                    espTags[player] = nil
                end
            end
        else
            if espTags[player] then
                espTags[player]:Destroy()
                espTags[player] = nil
            end
        end
    end
end)

-- เปิด/ปิด ESP ด้วยปุ่ม V
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end

    if input.KeyCode == Enum.KeyCode.V then
        toggleESP()
    end
end)
