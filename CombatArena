local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

local espEnabled = false
local espLines = {}

-- ฟังก์ชันเปิด-ปิด ESP
function toggleESP()
    espEnabled = not espEnabled

    if not espEnabled then
        for _, line in pairs(espLines) do
            line:Destroy()
        end
        espLines = {}
    end
end

-- ฟังก์ชันสร้างเส้น V สำหรับผู้เล่น
function createLineForPlayer(player)
    local line = Drawing.new("Line")
    line.Color = Color3.new(1, 0, 0) -- สีแดง
    line.Thickness = 2
    line.Transparency = 1
    line.Visible = true
    return line
end

-- ฟังก์ชันตรวจว่าโหมดปัจจุบันเป็น Deathmatch หรือไม่
local function isDeathmatchMode()
    local localPlayer = Players.LocalPlayer

    -- ตัวอย่างเงื่อนไข ตรวจสอบจากชื่อทีม หรือค่าตัวแปรใน Workspace หรือ Map
    -- แก้ไขตามเกมจริง เช่น:
    -- return workspace.GameMode and workspace.GameMode.Value == "Deathmatch"
    -- หรือถ้าไม่มีทีมเลยถือเป็น Deathmatch
    return (not localPlayer.Team) or (localPlayer.Team.Name == "None")
end

-- อัพเดตเส้น ESP ทุกเฟรม
RunService.RenderStepped:Connect(function()
    if not espEnabled then return end

    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    local deathmatch = isDeathmatchMode()
    local localPlayer = Players.LocalPlayer

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer 
           and player.Character 
           and player.Character:FindFirstChild("Head") then

            local showESP = false
            if deathmatch then
                showESP = true -- แสดงทุกคนในโหมด Deathmatch
            else
                if localPlayer.Team and player.Team and player.Team ~= localPlayer.Team then
                    showESP = true -- แสดงเฉพาะศัตรู
                end
            end

            if showESP then
                local headPos = player.Character.Head.Position
                local screenPos, _ = camera:WorldToViewportPoint(headPos)

                if not espLines[player] then
                    espLines[player] = createLineForPlayer(player)
                end

                espLines[player].From = screenCenter
                espLines[player].To = Vector2.new(screenPos.X, screenPos.Y)
                espLines[player].Visible = true
            else
                if espLines[player] then
                    espLines[player]:Destroy()
                    espLines[player] = nil
                end
            end
        else
            if espLines[player] then
                espLines[player]:Destroy()
                espLines[player] = nil
            end
        end
    end
end)

-- ควบคุมเปิดปิด ESP ด้วยปุ่ม V
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end

    if input.KeyCode == Enum.KeyCode.V then
        toggleESP()
    end
end)
